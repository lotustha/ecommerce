// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mysql"
}

// ==============================
// 1. AUTHENTICATION & USERS
// ==============================

enum Role {
  USER
  ADMIN
  STAFF
  RIDER
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  phone         String?   @unique
  password      String?
  emailVerified DateTime?
  image         String?
  role          Role      @default(USER)

  // Auth Relations
  accounts Account[]
  sessions Session[]

  // Customer Data
  orders    Order[]    @relation("CustomerOrders")
  reviews   Review[]
  wishlist  Wishlist[]
  addresses Address[]

  // Rider Data (If role is RIDER)
  assignedOrders Order[] @relation("RiderOrders")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ==============================
// 2. PRODUCT CATALOG (Electronics)
// ==============================

model Brand {
  id        String    @id @default(cuid())
  name      String    @unique
  slug      String    @unique
  image     String?
  products  Product[]
  createdAt DateTime  @default(now())
}

model Category {
  id        String     @id @default(cuid())
  name      String
  slug      String     @unique
  image     String?
  parentId  String?
  parent    Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children  Category[] @relation("CategoryHierarchy")
  products  Product[]
  createdAt DateTime   @default(now())
}

model Product {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String? @db.Text

  // Base Price (used if no variants)
  price         Decimal  @db.Decimal(10, 2)
  discountPrice Decimal? @db.Decimal(10, 2)
  stock         Int      @default(0)
  images        String?  @db.Text // JSON array: ["url1", "url2"]

  // Relations
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])
  brandId    String?
  brand      Brand?   @relation(fields: [brandId], references: [id])

  // Variants & Specs
  hasVariants     Boolean          @default(false)
  variants        ProductVariant[]
  specs           ProductSpec[] // Technical specs (RAM, CPU)
  options         String?          @db.Text
  // ✅ NEW: SEO Fields
  metaTitle       String?          @db.VarChar(255)
  metaDescription String?          @db.Text
  keywords        String?          @db.Text

  // ✅ NEW: Cross-Selling (Self-relation for "Frequently Bought Together")
  crossSells    Product[] @relation("CrossSells")
  crossSelledBy Product[] @relation("CrossSells")

  // Social & Transactions
  reviews       Review[]
  wishlistItems Wishlist[]
  cartItems     CartItem[]
  orderItems    OrderItem[]

  isFeatured Boolean  @default(false)
  isArchived Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model ProductVariant {
  id    String  @id @default(cuid())
  sku   String  @unique // Unique Stock Keeping Unit
  name  String // e.g. "Red / 128GB"
  price Decimal @db.Decimal(10, 2)
  stock Int     @default(0)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // ✅ NEW: Color tracking for smart UI rendering
  colorCode String? @db.VarChar(50)
  image     String? @db.LongText

  // Variants can be in cart/orders
  cartItems  CartItem[]
  orderItems OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Tech Specs for Comparison (e.g., Attribute: "Screen Type", Value: "OLED")
model Attribute {
  id     String        @id @default(cuid())
  name   String
  values ProductSpec[]
}

model ProductSpec {
  id          String    @id @default(cuid())
  value       String // "OLED", "120Hz"
  productId   String
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  attributeId String
  attribute   Attribute @relation(fields: [attributeId], references: [id])

  @@unique([productId, attributeId])
}

// ==============================
// 3. SHOPPING & MARKETING
// ==============================

model Coupon {
  id          String   @id @default(cuid())
  code        String   @unique // "DASAIN20"
  type        String   @default("PERCENTAGE") // PERCENTAGE or FIXED
  value       Decimal  @db.Decimal(10, 2) // The amount/percent
  minOrder    Decimal? @db.Decimal(10, 2)
  maxDiscount Decimal? @db.Decimal(10, 2)
  startDate   DateTime @default(now())
  expiresAt   DateTime
  isActive    Boolean  @default(true)
  usageLimit  Int? // Total times can be used
  usedCount   Int      @default(0)

  orders Order[]
}

model Cart {
  id        String     @id @default(cuid())
  userId    String? // Nullable for Guest
  items     CartItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model CartItem {
  id     String @id @default(cuid())
  cartId String
  cart   Cart   @relation(fields: [cartId], references: [id], onDelete: Cascade)

  productId String
  product   Product         @relation(fields: [productId], references: [id])
  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id])

  quantity Int
}

// ==============================
// 4. ORDERS & LOGISTICS
// ==============================

enum OrderStatus {
  PENDING
  PROCESSING
  READY_TO_SHIP
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
}

enum PaymentStatus {
  UNPAID
  PAID
  FAILED
  REFUNDED
}

enum DeliveryType {
  INTERNAL
  EXTERNAL
}

model Order {
  id     String  @id @default(cuid())
  userId String?
  user   User?   @relation("CustomerOrders", fields: [userId], references: [id])

  // Financials
  subTotal     Decimal @db.Decimal(10, 2)
  shippingCost Decimal @db.Decimal(10, 2)
  discount     Decimal @default(0) @db.Decimal(10, 2)
  totalAmount  Decimal @db.Decimal(10, 2)

  couponId String?
  coupon   Coupon? @relation(fields: [couponId], references: [id])

  // Status
  status        OrderStatus   @default(PENDING)
  paymentStatus PaymentStatus @default(UNPAID)
  paymentMethod String // "ESEWA", "KHALTI", "COD"

  // Delivery Info
  shippingAddress String @db.Text // JSON snapshot
  phone           String

  // Hybrid Delivery Logic
  deliveryType DeliveryType @default(EXTERNAL)

  // If Internal (Rider)
  riderId String?
  rider   User?   @relation("RiderOrders", fields: [riderId], references: [id])

  // If External (Pathao/Upaya)
  courier      String? // "PATHAO", "UPAYA"
  trackingCode String?
  deliveryUrl  String?

  items     OrderItem[]
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

model OrderItem {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String
  product   Product         @relation(fields: [productId], references: [id])
  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id])

  name     String // Snapshot of product name
  quantity Int
  price    Decimal @db.Decimal(10, 2) // Price at purchase
}

// ==============================
// 5. EXTRAS & LOCATION
// ==============================

model Review {
  id        String   @id @default(cuid())
  rating    Int
  comment   String?
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  createdAt DateTime @default(now())
}

model Wishlist {
  id        String  @id @default(cuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])

  @@unique([userId, productId])
}

model Address {
  id         String  @id @default(cuid())
  userId     String
  user       User    @relation(fields: [userId], references: [id])
  province   String
  district   String
  city       String
  ward       Int?
  street     String
  postalCode String?
  phone      String?
  isDefault  Boolean @default(false)
}

model ShippingRate {
  id        String   @id @default(cuid())
  province  String
  district  String? // If null, applies to whole province
  rate      Decimal  @db.Decimal(10, 2)
  minWeight Decimal? // Optional: for complex calc later
  maxWeight Decimal?
}

model SystemSetting {
  id String @id @default("default")

  // App Identity
  appName   String  @default("Nepal E-com")
  storeLogo String? @db.Text

  // Store Information
  storeName     String  @default("Nepal E-com")
  storeTaxId    String?
  storeSubtitle String? @default("Your quality destination")
  storeAddress  String? @db.Text
  storePhone    String?
  storeEmail    String?

  // Localization & Finance
  currency String  @default("NPR")
  taxRate  Decimal @default(0) @db.Decimal(10, 2)

  // Logistics & Shipping
  shippingCharge        Decimal  @default(150) @db.Decimal(10, 2)
  shippingMarkup        Decimal  @default(0) @db.Decimal(10, 2)
  freeShippingThreshold Decimal? @db.Decimal(10, 2)
  deliveryPartners      String?  @default("Pathao, Upaya")

  // ✅ LOGISTICS CONFIG
  enableStoreDelivery Boolean @default(true)
  enablePathao        Boolean @default(false)
  pathaoSandbox       Boolean @default(true)
  pathaoClientId      String?
  pathaoClientSecret  String?
  pathaoUsername      String?
  pathaoPassword      String?

  // ✅ NEPAL CAN MOVE (NCM) CONFIG
  enableNcm       Boolean @default(false)
  ncmSandbox      Boolean @default(true)
  ncmToken        String?
  ncmOriginBranch String? @default("TINKUNE")
  // Payment Gateway Toggles
  enableCod       Boolean @default(true)
  enableEsewa     Boolean @default(false)
  esewaSandbox    Boolean @default(true) // ✅ Added
  enableKhalti    Boolean @default(false)
  khaltiSandbox   Boolean @default(true) // ✅ Added
  enableSctPay    Boolean @default(false)

  // Payment API Credentials
  esewaId      String?
  esewaSecret  String?
  khaltiSecret String?
  sctPayKey    String?

  // Social Links
  socialFacebook  String?
  socialInstagram String?
  socialTiktok    String?
  socialTwitter   String?

  // AI & Legal
  aiOpenAiKey        String?
  aiGeminiKey        String?
  crawlerApiKey      String?
  privacyPolicy      String? @db.MediumText
  termsAndConditions String? @db.MediumText

  // Storefront CMS
  heroTitle    String? @default("Electronics 2025")
  heroSubtitle String? @default("Best Electronics Products in Nepal")
  heroImage    String? @db.Text

  // FUTURE-PROOF EMAIL NOTIFICATIONS
  mailProvider   String? @default("SMTP") // "SMTP" or "RESEND"
  storeEmailFrom String? @default("orders@nepalecom.com")

  // SMTP Config
  smtpHost     String?
  smtpPort     Int?    @default(465)
  smtpUser     String?
  smtpPassword String?

  // Resend Config (For future scaling)
  resendApiKey String?

  updatedAt DateTime @updatedAt
}
